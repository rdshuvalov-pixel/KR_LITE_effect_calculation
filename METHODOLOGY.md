# Методология оценки эффективности ценообразования

## 1. Общие принципы

Оценка эффективности производится методом сравнительного анализа (Difference in Differences / Lift) продаж тестовых товаров относительно контрольной группы товаров.

### Определения
- **Тестовый товар**: Товар, для которого была установлена новая цена (присутствует на вкладке "Тестовые цены").
- **Контрольная группа**: Товары, цена на которые не менялась (отсутствуют на вкладке "Тестовые цены").
- **Дата старта теста ($T_{start}$)**: Самая ранняя дата начала действия новой цены для конкретного товара.
- **Неделя**: Полная календарная неделя (Понедельник - Воскресенье).

## 2. Формирование периодов

### Динамический поиск Дотестового периода (Pre-test)
Дотестовый период выбирается автоматически, исходя из наличия товара на остатках. Это позволяет избежать сравнения с периодом, когда товара не было в наличии.

**Параметры поиска:**
1.  **Длительность ($N_{weeks}$)**: Количество недель в периоде (по умолчанию 3).
2.  **Порог доступности ($Stock_{threshold}$)**: Минимальный процент дней, когда товар был на остатке (по умолчанию 70%).

**Алгоритм:**
1.  Поиск начинается с недели, непосредственно предшествующей дате старта теста (минус переходная неделя).
2.  Анализируется временное окно длиной $N$ недель, смещаясь назад по времени.
3.  **Строгая проверка**: Для *каждой недели* окна проверяется условие доступности.
    -   Количество дней со стоком в неделе $\ge 7 \times (Stock_{threshold} / 100)$.
    -   Если хотя бы одна неделя не удовлетворяет условию, окно считается невалидным.
4.  Первое окно, в котором **все недели** удовлетворяют порогу доступности, фиксируется как **Базовый Дотестовый Период**.
5.  Если подходящий период не найден в пределах разумного горизонта (26 недель), товар исключается из анализа.

### Тестовый период (Test)
- Начинается с первой полной недели после $T_{start}$ (или с недели $T_{start}$, если она началась в понедельник).
- Длится до конца доступных данных (исключая последнюю неполную неделю).

## 3. Расчет метрик и Фильтрация

### Фильтрация Тестовых недель (Stock Availability)
Для исключения влияния Out-Of-Stock в *тестовом* периоде применяется фильтр:
-   **Критерий**: Если средний остаток недели $w$ меньше Базового остатка (из найденного Pre-test) на $X\%$, неделя исключается.
-   Параметр $X$ задается пользователем (default 50%).

### Базовые показатели ($R$)

1.  **$R_{tb}$ (Revenue Test Base)**:
    -   Рассчитывается по найденному динамическому Дотестовому периоду ($N$ недель).
    -   **Важно**: При расчете среднего **исключаются** недели без фактических продаж (Data Gaps Excluded). Это сделано для того, чтобы не занижать базу сравнения, если в "хорошем по стоку" периоде случайно не было продаж.
    -   *Формула*: Сумма выручки за недели с продажами / Кол-во недель с продажами.

2.  **$R_{tt}$ (Revenue Test Test)**:
    -   Рассчитывается для тестового периода.
    -   **Недели без продаж учитываются как 0** (если они не отфильтрованы по стоку). Это отражает реальное падение спроса.
    -   *Формула*: Сумма выручки за все валидные недели / Кол-во валидных недель.

3.  **$R_{ct}, R_{cb}$**:
    -   Аналогичные показатели контрольной группы за соответствующие периоды.

### Расчет Эффекта (Effect)

$$ Effect_{i,w} = \left( \frac{R_{tt}}{R_{tb}} - 1 \right) - \left( \frac{R_{ct}}{R_{cb}} - 1 \right) $$

### Расчет в деньгах (Absolute Effect)

$$ AbsEffect_{i,w} = Effect_{i,w} \times FactRevenue_{i,w} $$

### Итоговые показатели
- **Полный эффект (Total Effect)**: Сумма $AbsEffect$ по всем *валидным* неделям.
- **Эффект в %**: $\frac{TotalEffect}{\sum FactRevenue_{valid} - TotalEffect} \times 100\%$
